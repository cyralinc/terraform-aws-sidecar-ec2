# Upgrade Notes

## Upgrading from module v4 to v5

Upgrading from any `v4.x` to any `v5.y` version of this module will cause
the self-signed certificate that is automatically generated by the sidecar
to be recreated. If you verify the self-signed certificate in your client
TLS connections, you will have to accept the new one.

### Changes in default values

- `health_check_grace_period` -- Default value change from `600` (10 minutes) to `300` (5 minutes) to speed up deployment and upgrades.
- `volume_type` -- Default value change from `gp2` to `gp3`.

### Removed input variables

- `asg_count` -- No longer used.
- `dd_api_key` -- No longer used.
- `deploy_certificate_lambda` -- No longer used. Lambda got removed in favour
of the Terraform TLS provider for self-signed certificate creation.
- `deploy_secrets` -- No longer used. The secret will be created by the module
automatically if `secret_name` is empty. If `secret_name` assumes
any value, it means the user created the secret externally to the module and
it should not be responsible for managing it.
- `hc_vault_integration_id` -- No longer used. Retrieved from the control plane
when sidecar is running.
- `log_integration` -- No longer used. Retrieved from the control plane when
sidecar is running.
- `metrics_integration` -- No longer used.
- `sidecar_custom_certificate_account_id` -- No longer used. Corresponding
feature no longer exists. See the [Sidecar certificates](https://github.com/cyralinc/terraform-aws-sidecar-ec2/blob/main/docs/certificates.md)
page to get more information on how to use custom certificates with your
sidecar.
- `use_single_container` -- No longer used.

### Renamed output variables

- `aws_cloudwatch_log_group_name` -> `cloudwatch_log_group_name`
- `aws_iam_role_arn` -> `iam_role_arn`
- `aws_security_group_id` -> `security_group_id`
- `sidecar_ca_certificate_role_arn` -> `ca_certificate_role_arn`
- `sidecar_ca_certificate_secret_arn` -> `ca_certificate_secret_arn`
- `sidecar_credentials_secret_arn` -> `secret_arn`
- `sidecar_custom_host_role` -> `custom_host_role`
- `sidecar_dns_hosted_zone_id` -> `dns_hosted_zone_id`
- `sidecar_dns` -> `dns`
- `sidecar_dns_name` -> `dns_name`
- `sidecar_load_balancer_dns` -> `load_balancer_dns`
- `sidecar_tls_certificate_role_arn` -> `tls_certificate_role_arn`
- `sidecar_tls_certificate_secret_arn` -> `tls_certificate_secret_arn`


## Upgrading from module v3 to v4

### Removed variables

- `elk_address` -- no longer used. Retrieved from the control plane when sidecar is running.
- `elk_password` -- no longer used. Retrieved from the control plane when sidecar is running.
- `elk_username` -- no longer used. Retrieved from the control plane when sidecar is running.
- `healthcheck_inbound_cidr` -- use `monitoring_inbound_cidr` instead.
- `healthcheck_port` -- fixed to port `9000`.
- `metrics_inbound_cidr` -- use `monitoring_inbound_cidr` instead.
- `metrics_port` -- fixed to port `9000`.
- `mongodb_port_alloc_range_high` -- no longer used. Retrieved from the control plane when sidecar is running.
- `mongodb_port_alloc_range_low` -- no longer used. Retrieved from the control plane when sidecar is running.
- `mysql_multiplexed_port` -- no longer used. Retrieved from the control plane when sidecar is running.
- `splunk_host` -- no longer used. Retrieved from the control plane when sidecar is running.
- `splunk_index` -- no longer used. Retrieved from the control plane when sidecar is running.
- `splunk_port` -- no longer used. Retrieved from the control plane when sidecar is running.
- `splunk_tls` -- no longer used. Retrieved from the control plane when sidecar is running.
- `splunk_token` -- no longer used. Retrieved from the control plane when sidecar is running.
- `sumologic_host` -- no longer used. Retrieved from the control plane when sidecar is running.
- `sumologic_uri` -- no longer used. Retrieved from the control plane when sidecar is running.

### Deprecated variables

- `dd_api_key` -- Unused in sidecars `v4.10+`. Will be removed in the next major version of this module.
- `hc_vault_integration_id` -- Unused in sidecars `v4.10+`. Will be removed in the next major version of this module.
- `metrics_integration` -- Unused in sidecars `v4.10+`. Will be removed in the next major version of this module.
- `repositories_supported` -- Unused in sidecars `v4.10+`. Will be removed in the next major version of this module.

## Upgrading from module 2.x.y to 3.0.0 or later

### Deprecated variables

#### mongodb_port_alloc_range_low and mongodb_port_alloc_range_high

The MongoDB port allocation variables were deprecated in all sidecars `3.0` or later and will be removed in 
the version `4.0` of this module. This information is now retrieved by the sidecar from the repository 
configuration in the control plane.

#### mysql_multiplexed_port

The MySQL multiplexed port configuration variable was deprecated in all sidecars `4.0` or later and will be 
removed in the version `4.0` of this module. This information is now retrieved by the sidecar from the 
repository and sidecar configurations in the control plane.

## Upgrading from module 1.x.y to 2.2.0 or later

### New variables

#### sidecar_ports

This variable replaces all the following previous variables:
* `sidecar_dremio_ports`
* `sidecar_http_ports`
* `sidecar_mongodb_ports`
* `sidecar_mysql_ports`
* `sidecar_oracle_ports`
* `sidecar_postgresql_ports`
* `sidecar_rest_ports`
* `sidecar_snowflake_ports`
* `sidecar_sqlserver_ports`
* `sidecar_s3_ports`

`sidecar_ports` does not define a range of ports as previous variables, so you need to provide those ports that you will use to expose your repositories. For example: if you have 2 SQL Server database and 4 PostgreSQL databases that you want to expose using a single sidecar and assuming you are starting with the default ports for each database vendor, they you could assign `[1433, 1434, 5432, 5433, 5434, 5435]`. In this example, you would expose the two SQL Server instances in ports `1433` and `1434` and the four PostgreSQL instances in the remaining ports, meaning that users would connect to the database using, for example, `mysidecardns.mycompany.com:1433`, `mysidecardns.mycompany.com:1434`, etc.

The maximum number of ports that can be assigned to a sidecar depends on the maximum number of listeners per load balancer as defined by AWS (currently set to `50` - [see also](https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-limits.html)).

#### mongodb_port_alloc_range_low and mongodb_port_alloc_range_high

Defines the lower and upper limit values for the port allocation range reserved for MongoDB. This range must correspond to the range of ports declared in `sidecar_ports` that will be used for MongoDB. If you assign to `sidecar_ports` the consecutive ports `27017`, `27018` and `27019` for MongoDB utilization, it means that the corresponding `mongodb_port_alloc_range_low` is `27017` and `mongodb_port_alloc_range_high` is `27019`. If you want to use a range of `10` ports for MongoDB, then you need to add all consecutive ports to `sidecar_ports` (ex: `27017, 27018, 27019, 27020, 27021, 27022, 27023, 27024, 27025, 27026`) and define `mongodb_port_alloc_range_low = 27017` and `mongodb_port_alloc_range_high = 27026`.


## Upgrading from module 1.0.0 to any later version

### Problem statement

From `v1.0.0` to `v1.0.1` the [initial lifecycle hook](https://github.com/cyralinc/terraform-aws-sidecar-ec2/compare/v1.0.0..v1.0.1?w=1#diff-836bec1886b2c2541da0493911f05e0694664823712aed280b7c0ec46b3374c6L97-L103) and [asg complete-lifecycle-action](https://github.com/cyralinc/terraform-aws-sidecar-ec2/compare/v1.0.0..v1.0.1?w=1#diff-07d951da97790e193f01a72f55ad6a082775e409060eced3a16096492f829018L18) were removed. This change was tested in new sidecars, but during some upgrade tests, we noticed an issue with Terraform AWS provider.

When a sidecar originally created with module `1.0.0` is upgraded to `1.0.1` or later, Terraform correctly shows in the execution plan that the `initial_lifecycle_hook` will be deleted, but it does not remove it after `terraform apply`. The issue is caused by the fact that the latest version of the AWS Provider does not support updates or deletes that only target the `initial_lifecycle_hook` when it is part of the resource `aws_autoscaling_group`. For this reason, it is impossible to remove the element during sidecar upgrade. The support for creation of `initial_lifecycle_hook` during ASG creation was [added in 2016](https://github.com/hashicorp/terraform-provider-aws/commit/f56c992e3036e3e7e94c63e996ee79457f250b9a) and no changes in this specific element were performed up to [moment this upgrade note was written](https://github.com/hashicorp/terraform-provider-aws/releases/tag/v3.47.0).

### Solution

The upgrade from `1.0.0` to `1.0.1` or later requires the following procedure. It will be performed once in the lifetime of the sidecar:

* Run `terraform apply` normaly as in any upgrade;
* Open AWS EC2 Console and go to [Auto Scaling groups
](https://console.aws.amazon.com/ec2autoscaling/);
* Open the auto scaling group for the target sidecar. The name follows the form `${var.name_prefix}-asg`;
* Open the tab `Instance management`;
* Scroll down to `Lifecycle hooks`;
* Select the lifecycle hook which name follows the form `${var.name_prefix}-InitLifeCycleHook` and **delete it**;
* Proceed normally to the **instance refresh** whenever it is more convenient.
